base:
  os: ubuntu 24.04
  tag: 1.2

tasks:
  - key: code
    call: git/clone 1.6.9
    with:
      repository: https://github.com/rwx-research/captain.git
      ref: ${{ init.commit-sha }}
      github-access-token: ${{ github.token }}
      preserve-git-dir: true

  - key: tool-versions
    use: code
    call: rwx/tool-versions 1.0.4
    filter:
      - .tool-versions

  - key: golang
    call: golang/install 1.1.4
    with:
      go-version: ${{ tasks.tool-versions.values.golang }}

  - key: mage-source
    call: git/clone 1.6.9
    with:
      repository: https://github.com/magefile/mage.git
      ref: v${{ tasks.tool-versions.values.mage }}
      path: /tmp/mage

  - key: mage
    use: [mage-source, golang]
    run: |
      cd /tmp/mage
      mkdir $HOME/go # Mage assumes this already exists
      go run bootstrap.go
      echo $PATH:$HOME/go/bin > $RWX_ENV/PATH

  - key: legacy-test-suite-tags
    use: [code, mage]
    run: mage legacyTestSuiteTags | tee $RWX_VALUES/versions

  - key: backwards-compatibility-tests
    if: ${{ tasks.legacy-test-suite-tags.values.versions != "[]" }}
    parallel:
      matrix:
        version: ${{ tasks.legacy-test-suite-tags.values.versions }}
    call: ${{ run.dir }}/test-backwards-compatibility.yml
    init:
      commit-sha: ${{ init.commit-sha }}
      legacy-version: ${{ parallel.version }}
