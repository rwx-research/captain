on:
  github:
    push:
      init:
        trigger: push
        commit-sha: ${{ event.git.sha }}
        branch: ${{ event.git.branch }}

concurrency-pools:
  - id: rwx-research/captain:ci:${{ init.branch }}:${{ init.trigger }}
    if: ${{ init.branch != "main" }}
    capacity: 1
    on-overflow: cancel-running

base:
  os: ubuntu 24.04
  tag: 1.2

tasks:
  - key: test
    call: ${{ run.dir }}/test.yml
    init:
      commit-sha: ${{ init.commit-sha }}
      trigger: ${{ init.trigger }}

  - key: buildkite-tests
    call: ${{ run.dir }}/buildkite.yml
    init:
      commit-sha: ${{ init.commit-sha }}

  - key: backwards-compatibility-tests
    call: ${{ run.dir }}/generate-backwards-compatibility-tests.yml
    init:
      commit-sha: ${{ init.commit-sha }}

  - key: lint
    call: ${{ run.dir }}/lint.yml
    init:
      commit-sha: ${{ init.commit-sha }}

  - key: release-unstable
    after: test
    if: ${{ init.branch == 'main' }}
    call: ${{ run.dir }}/release.yml
    init:
      commit-sha: ${{ init.commit-sha }}
      kind: unstable
      version: ""
