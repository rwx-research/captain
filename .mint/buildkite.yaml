tasks:
  - key: install-buildkite-agent
    run: |
      curl -fsSL https://keys.openpgp.org/vks/v1/by-fingerprint/32A37959C2FA5C3C99EFBC32A79206696452D198 | sudo gpg --dearmor -o /usr/share/keyrings/buildkite-agent-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/buildkite-agent-archive-keyring.gpg] https://apt.buildkite.com/buildkite-agent stable main" | sudo tee /etc/apt/sources.list.d/buildkite-agent.list
      sudo apt-get update && sudo apt-get install -y buildkite-agent
      sudo sed -i "s/xxx/$BUILDKITE_AGENT_TOKEN/g" /etc/buildkite-agent/buildkite-agent.cfg
    env:
      BUILDKITE_AGENT_TOKEN: ${{ secrets.BUILDKITE_AGENT_TOKEN }}

  - key: run-buildkite-agent
    use: [install-buildkite-agent]
    cache: false
    background-processes:
      - key: buildkite-agent
        run: |
          sudo tee /etc/buildkite-agent/hooks/environment > /dev/null <<'EOF'
          #!/usr/bin/env bash
          export RWX_ACCESS_TOKEN="${{ secrets.RWX_ACCESS_TOKEN }}"
          export RWX_ACCESS_TOKEN_STAGING="${{ secrets.RWX_ACCESS_TOKEN_STAGING }}"
          EOF
          sudo chmod +x /etc/buildkite-agent/hooks/environment

          sudo buildkite-agent start
    run: |
      sleep 120
    env:
      BUILDKITE_AGENT_TOKEN: ${{ secrets.BUILDKITE_AGENT_TOKEN }}
